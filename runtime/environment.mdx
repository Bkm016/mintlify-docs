---
title: "环境与作用域"
description: "Environment 在函数、变量与扩展函数中的职责"
---

`Environment` 是 Fluxon 运行时最核心的状态容器，位于 `core/src/.../runtime/Environment.java`。它负责管理全局与局部变量、系统函数、扩展函数以及上下文目标（`target`）。理解它的布局是调试解释器行为的首要步骤。

## 根环境与子环境

- 顶层环境由 `FluxonRuntime#newEnvironment()` 创建，构造函数接收：
  - 系统函数映射 `Map<String, Function>`。
  - 预烘焙的函数数组 `Function[]`（提升访问性能）。
  - 系统变量（如全局对象）。
  - 扩展函数映射及其 `KV<Class<?>, Function>[][]` 索引。
- 每次函数调用都会通过 `new Environment(parentEnv, localSize)` 创建一个子环境，只持有局部变量数组与名称表。
- 所有根级别的资源（函数、变量、扩展函数）都会透过 `root` 引用共享，避免重复复制。

## 函数分派

- `getFunction` 与 `getFunctionOrNull` 直接在根 `Map` 中查找，如果缺失则抛出 `FunctionNotFoundError`。
- 扩展函数调用会先尝试索引加速：
  - `systemExtensionFunctions` 是在 `FluxonRuntime#bake` 阶段构建的二维数组，按函数名编号。
  - 如果索引失败，再回退到名称 -> 类型映射的 `extensionFunctions`。
- 找到后返回 `Function` 对象，让上层 `FunctionContext` 负责执行。

## 变量存储

- 根变量保存在 `rootVariables` 中，供 `defineRootVariable` 与 `assign(..., index = -1)` 调整。
- 子环境通过 `Object[] localVariables` 与 `String[] localVariableNames` 维护局部变量。
- `assign` 会根据索引决定写入根变量还是局部变量，若索引越界会抛出 `VariableNotFoundError` 并附带 `localVariableNames` 调试信息。

## 上下文目标 (`target`)

- `Environment#setTarget` / `getTarget` 用于 `value :: function()` 语法，将左操作数写入上下文目标槽。
- 上下文执行完毕后，解释器负责恢复旧的 `target`，因此 `Environment` 本身保持无状态能力，只提供存储位。

## 导出辅助 API

`Environment` 暴露若干 `@Export` 方法（如 `getRootFunctions`, `getRootExtensionFunctions`），允许脚本或外部工具在运行时枚举当前已注册的函数，方便调试 `dumpFluxonCatalog` 之外的场景。

通过梳理 `Environment` 的字段和行为，可以确保新增函数或扩展时不会意外污染局部状态，也能更快定位“函数未定义”“变量覆盖”等问题。