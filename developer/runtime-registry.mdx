---
title: "运行时注册 API"
description: "FluxonRuntime 中可用的函数/扩展注册入口"
---

此文档直接基于 `core/src/main/java/org/tabooproject/fluxon/runtime/FluxonRuntime.java`，列出所有可调用的注册接口，帮助你在运行时新增函数、变量或扩展。

## 单例访问

```java
FluxonRuntime runtime = FluxonRuntime.getInstance();
```

- `newEnvironment()`：创建新的解释器环境（会自动 bake 缓存）。
- `getSystemFunctions()` / `getExtensionFunctions()` / `getSystemVariables()`：调试或导出当前注册表。
- `setPrimaryThreadExecutor(Executor executor)`：替换主线程执行器，供 `isPrimarySync` 函数使用。

## 函数注册

| 方法 | 用途 |
| --- | --- |
| `registerFunction(name, paramCount, callable)` | 注册同步函数。可传入 `List<Integer>` 支持多种参数个数。 |
| `registerFunction(namespace, name, paramCount, callable)` | 带命名空间的函数，例如 `fs:crypto`。 |
| `registerAsyncFunction(...)` | 注册异步函数，`Function#isAsync()` 为 `true`。 |
| `registerPrimarySyncFunction(...)` | 标记为主线程执行（`isPrimarySync = true`）。 |
| `registerVariable(name, value)` | 注入全局变量，可在脚本中直接访问。 |

所有注册操作都会把内部脏标记设为 `true`，下一次 `newEnvironment()` 前自动重建缓存。

## 扩展函数

### Builder 链式注册

```java
runtime.registerExtension(File.class, "fs:io")
       .function("readText", 0, ctx -> ...)
       .function("writeText", 1, ctx -> ...);
```

`ExtensionBuilder` 仅是语法糖，底层仍调用 `registerExtensionFunction`。

### 直接注册

| 方法 | 说明 |
| --- | --- |
| `registerExtensionFunction(Class<T> type, String name, int paramCount, callable)` | 同步扩展函数。 |
| `registerExtensionFunction(type, namespace, name, List<Integer>, callable)` | 带命名空间及多参数版本。 |
| `registerAsyncExtensionFunction(...)` | 异步扩展函数。 |
| `registerSyncExtensionFunction(...)` | 主线程扩展函数。 |

扩展函数也参与 `fluxon-functions.json` 导出，供 IDE/文档消费。

## 变量与全局对象

- `registerVariable("g", GlobalObject.INSTANCE)`：运行时默认注册一个 `g` 函数返回 `GlobalObject`，供上下文调用使用。
- 任意 `registerVariable` 注入的对象都可通过 `Environment#getRootVariables()` 查看。

通过以上 API，可以在不修改核心源码的情况下，向 Fluxon runtime 注入新的系统能力。